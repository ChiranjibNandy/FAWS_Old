<br>
<div class="rs-container migration-mgr" ng-style="vm.isRacker == true ? {'margin-top':'30px'} : {'margin-top':'0px'}">
    <div class="alert alert-success animated fadeIn" ng-if="vm.afterNewMigration">
        <button type="button" class="close" data-dismiss="alert"><i class="fa fa-times"></i></button>
        <h3>Success! Migration for {{vm.resourceCount}} resources confirmed at {{vm.schedule.date}} at {{vm.schedule.time}}</h3>
    </div>
    <div class="rs-main rs-panel">
        <div class="rs-content rs-panel">
            <div class="rs-inner">
                <div class="rs-row">
                    <div class="span-8">
                        <div class="migr-ddi-name">
                            {{vm.currentUser}} ( #{{vm.tenant_id}} )
                        </div>
                        <h3>Welcome to your Migration Dashboard, you have <b><em>{{vm.currentBatches.items.length + vm.completedBatches.items.length}} batches</em></b>.</h3> 
                    </div>
                    <div class="span-4 ">
                        <div class="pull-right">
                            <button class="rs-btn" ng-click="vm.getBatches(true)">
                                <i class="fa fa-refresh" ng-class="{'fa-spin': vm.loading || vm.manualRefresh}"></i> 
                                <small><em class="rs-quiet">Refresh</em></small>
                            </button>
                            <button class="rs-btn rs-btn-primary" ng-click="vm.startNewMigration()"><i class="fa fa-plus-square fa-fw"></i> Start New Migration</button>
                            <div style="margin-top: 10px;" ng-show="!vm.loading && !vm.manualRefresh && !vm.loadError">Last refreshed: {{vm.timeSinceLastRefresh===0 ? " just now" : vm.timeSinceLastRefresh + (vm.timeSinceLastRefresh>1 ? " mins ": " min ") + "ago"}}</div>
                        </div>
                    </div>
                </div>
                <div class="migration-status-list-container table-justify">
                    <table class="rs-list-table no-truncate-td cell-center">
                        <thead>
                            <tr>
                                <th class="rs-table-status"></th>
                                <th>
                                    <a href="javascript:void(0);" class="rs-table-sort" ng-click="vm.setSortBy('current_batch', 'batch_name')" ng-class="{'custom-table-sort-asc current-sort-param': vm.sortBy['current_batch']==='batch_name', 'custom-table-sort-desc current-sort-param': vm.sortBy['current_batch']==='-batch_name', 'custom-table-sort-desc': vm.sortBy['current_batch'].indexOf('batch_name') < 0}">
                                        <span class="rs-table-sort-text">Batch Queue</span>
                                        <span class="rs-table-sort-indicator"></span>
                                    </a>
                                </th>
                                <th>
                                    <a href="javascript:void(0);" class="rs-table-sort">
                                        <span class="rs-table-sort-text">Batch Initiated by</span>
                                        <!--<span class="rs-table-sort-indicator"></span>-->
                                    </a>
                                </th>
                                <th>
                                    <a href="javascript:void(0);" class="rs-table-sort" ng-click="vm.setSortBy('current_batch', 'start')" ng-class="{'custom-table-sort-asc current-sort-param': vm.sortBy['current_batch']==='start', 'custom-table-sort-desc current-sort-param': vm.sortBy['current_batch']==='-start', 'custom-table-sort-desc': vm.sortBy['current_batch'].indexOf('start') < 0}">
                                        <span class="rs-table-sort-text">Start Date/Time</span>
                                        <span class="rs-table-sort-indicator"></span>
                                    </a>
                                </th>
                                <th>
                                    <a href="javascript:void(0);" class="rs-table-sort" ng-click="vm.setSortBy('current_batch', 'batch_status')" ng-class="{'custom-table-sort-asc current-sort-param': vm.sortBy['current_batch']==='batch_status', 'custom-table-sort-desc current-sort-param': vm.sortBy['current_batch']==='-batch_status', 'custom-table-sort-desc': vm.sortBy['current_batch'].indexOf('batch_status') < 0}">
                                        <span class="rs-table-sort-text">Status</span>
                                        <span class="rs-table-sort-indicator"></span>
                                    </a>
                                </th>
                                <!--<th>
                                    <span class="rs-table-sort-text">Progress</span>
                                </th>-->
                                <th class="rs-table-cog rs-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody ng-show="!vm.loading && !vm.currentBatches.loadError && vm.showInitiatedMigration">
                            <tr>
                                <td class="rs-table-status tip rs-table-status-ok"></td>
                                <td class="rs-table-link">
                                    {{vm.initiatedMigration.name}}
                                </td>
                                <td>{{vm.batchInitiatedBy}}</td>
                                <td class="rs-table-text ng-binding">
                                    <span ng-show="!batch.timestamp">{{(vm.initiatedMigration.timestamp && vm.initiatedMigration.timestamp * 1000) | date : 'M/dd/yyyy hh:mm a'}}</span>
                                </td>
                                <td class="rs-table-text">
                                    <span class="rs-status-ok">Queued</span>                                    
                                </td>
                                <td class="rs-table-input rs-center">
                                    <div class="rs-btn-group">
                                        <div class="rs-dropdown">
                                            <div class="rs-cog rs-dropdown-toggle" ng-click="vm.showQueuedBatchMenu = true;"></div>
                                            <ul class="rs-dropdown-menu visible" ng-show="vm.showQueuedBatchMenu" style="right: 0 !important">
                                                <li class="disabled"><a href="#">Modify Migration (NA)</a></li>
                                                <li class="disabled"><a href="#">Cancel Migration (NA)</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        <tbody ng-show="!vm.loading && !vm.currentBatches.loadError && vm.currentBatches.items.length!==0">
                            <tr ng-repeat="batch in vm.currentBatches.items | orderBy: vm.sortBy.current_batch | limitTo : vm.currentBatches.pageSize : (vm.currentBatches.currentPage-1)*vm.currentBatches.pageSize" class="ng-scope">
                                <td class="rs-table-status tip" ng-class="{'rs-table-status-pending': (batch.batch_status==='not available' || batch.timestamp), 'rs-table-status-warning': batch.batch_status==='scheduled', 'rs-table-status-ok rs-table-status-ok-processing rs-table-status-striped': batch.batch_status==='in progress', 'rs-table-status-error': batch.batch_status==='error'}"></td>
                                <td class="rs-table-link">
                                    <a ng-show="!batch.timestamp" ng-link="['CurrentBatchDetails', {job_id: batch.job_id}]">{{batch.batch_name}}</a>
                                    <a ng-show="batch.timestamp" href="javascript:void(0)" ng-click="vm.continueScheduling(batch);">{{batch.batch_name}}</a>
                                </td>
                                <td>{{vm.batchInitiatedBy}}</td>
                                <td class="rs-table-text ng-binding">
                                    <span ng-show="!batch.timestamp">{{(batch.start && batch.start * 1000) | date : 'M/dd/yyyy hh:mm a'}}</span>
                                </td>
                                <td class="rs-table-text">
                                    <span class="rs-status-disabled" ng-show="batch.timestamp">Not Scheduled</span>
                                    <span class="rs-status-disabled" ng-show="batch.batch_status==='not available'">Not Available</span>
                                    <span class="rs-status-warning" ng-show="batch.batch_status==='scheduled'">Scheduled</span>
                                    <span class="rs-status-ok" ng-show="batch.batch_status==='in progress'">In Progress</span>
                                    <span class="rs-status-ok" ng-show="batch.batch_status==='started'">Started</span>
                                    <span class="rs-status-ok" ng-show="batch.batch_status==='done'">Completed</span>
                                    <span class="rs-status-error" ng-show="batch.batch_status==='error'">Error</span>
                                    <span class="rs-status-warning" ng-show="batch.batch_status==='paused'">Paused</span>
                                </td>
                                <!--<td class="rs-table-text">
                                    <div ng-show="!batch.timestamp">
                                        <div class="rs-progress rs-progress-medium" style="width: 70%;">
                                            <div class="rs-progress-inner">
                                                <div class="rs-segment" style="width: {{['started', 'in progress', 'paused'].indexOf(batch.batch_status)>=0 ? 50 : 0}}%">
                                                    <div class="rs-bar" ng-class="{'rs-status-ok rs-bar-striped': ['started', 'in progress'].indexOf(batch.batch_status)>=0, 'rs-status-error': batch.batch_status==='error', 'rs-status-warning': batch.batch_status==='paused'}"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <span class="rs-progress-label">{{ ['started', 'in progress', 'paused'].indexOf(batch.batch_status)>=0 ? 50 : 0 }}%</span>
                                    </div>
                                </td>-->
                                <td class="rs-table-input rs-center">
                                    <div class="rs-btn-group">
                                        <div class="rs-dropdown">
                                            <div class="rs-cog rs-dropdown-toggle" ng-click="vm.showActionList(batch)"></div>
                                            <ul class="rs-dropdown-menu visible" ng-show="batch.showSettings" style="right: 0 !important">
                                                <li><span class="rs-dropdown-category">Manage</span></li>
                                                <li ng-show="batch.timestamp"><a href="javascript:void(0)" ng-click="vm.continueScheduling(batch)">Continue Scheduling</a></li>
                                                <li ng-show="batch.timestamp && !batch.deleting">
                                                    <a ng-show="!batch.deleting" href="javascript:void(0)" ng-click="vm.deleteSavedSchedule(batch)">Delete</a>
                                                </li>
                                                <li class="disabled" ng-show="batch.deleting"><a href="#">Deleting...</a></li>
                                                <!--<li><a href="#">See log</a></li>-->
                                                <li class="disabled"><a href="#">Modify Migration (NA)</a></li>
                                                <li class="disabled"><a href="#">Cancel Migration (NA)</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        <tbody ng-show="vm.loading">
                            <tr>
                                <td colspan="6">
                                    <div class="rs-table-overlay rs-table-overlay-loading">
                                        <div class="rs-table-overlay-content">
                                            <div class="rs-table-overlay-message">Loading&hellip;</div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        <tbody ng-show="!vm.loading && !vm.currentBatches.loadError && vm.currentBatches.items.length===0 && !vm.showInitiatedMigration">
                            <tr>
                                <td colspan="6" class="empty-collection-info">You don't have any migrations running at the moment.</td>
                            </tr>
                        </tbody>
                        <tbody ng-show="!vm.loading && vm.currentBatches.loadError">
                            <tr>
                                <td colspan="6" class="collection-error-msg">Error loading data</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <br>
                <div class="pagination pagination-mini" ng-show="!vm.loading && vm.currentBatches.items.length!==0">
                    <ul>
                        <li><span>Showing {{(vm.currentBatches.currentPage == 1 ? vm.currentBatches.currentPage : ((vm.currentBatches.currentPage-1)*5)+1)}}-{{(vm.currentBatches.currentPage == vm.currentBatches.noOfPages ? vm.currentBatches.items.length : vm.currentBatches.currentPage*5)}} of {{vm.currentBatches.items.length}}</span></li>
                        <li ng-class="{disabled: vm.currentBatches.currentPage == 1}" ng-click="vm.currentBatches.currentPage=vm.currentBatches.currentPage-1"><a href="">Prev</a></li>
                        <li ng-repeat="n in vm.currentBatches.pages track by $index" ng-click="vm.currentBatches.currentPage = $index+1"><a href="">{{$index+1}}</a></li>
                        <li ng-class="{disabled: vm.currentBatches.currentPage == vm.currentBatches.noOfPages}" ng-click="vm.currentBatches.currentPage=vm.currentBatches.currentPage+1"><a href="">Next</a></li>
                    </ul>
                </div>  
            
                <div class="migration-status-list-container table-justify">
                    <table class="rs-list-table secondary-table">
                        <thead>
                            <tr>
                                <th class="rs-table-status"></th>
                                <th>
                                    <a href="javascript:void(0);" class="rs-table-sort" ng-click="vm.setSortBy('completed_batch', 'batch_name')" ng-class="{'custom-table-sort-asc current-sort-param': vm.sortBy['completed_batch']==='batch_name', 'custom-table-sort-desc current-sort-param': vm.sortBy['completed_batch']==='-batch_name', 'custom-table-sort-desc': vm.sortBy['completed_batch'].indexOf('batch_name') < 0}">
                                        <span class="rs-table-sort-text">Completed Batches</span>
                                        <span class="rs-table-sort-indicator"></span>
                                    </a>
                                </th>
                                <th>
                                    <a href="javascript:void(0);" class="rs-table-sort" ng-click="vm.setSortBy('completed_batch', 'start')" ng-class="{'custom-table-sort-asc current-sort-param': vm.sortBy['completed_batch']==='start', 'custom-table-sort-desc current-sort-param': vm.sortBy['completed_batch']==='-start', 'custom-table-sort-desc': vm.sortBy['completed_batch'].indexOf('start') < 0}">
                                        <span class="rs-table-sort-text">Start Date/Time</span>
                                        <span class="rs-table-sort-indicator"></span>
                                    </a>
                                </th>
                                <th colspan="2">
                                    <a href="javascript:void(0);" class="rs-table-sort" ng-click="vm.setSortBy('completed_batch', 'end')" ng-class="{'custom-table-sort-asc current-sort-param': vm.sortBy['completed_batch']==='end', 'custom-table-sort-desc current-sort-param': vm.sortBy['completed_batch']==='-end', 'custom-table-sort-desc': vm.sortBy['completed_batch'].indexOf('end') < 0}">
                                        <span class="rs-table-sort-text">Completed Date/Time</span>
                                        <span class="rs-table-sort-indicator"></span>
                                    </a>
                                </th>
                                <!--<th ng-show="vm.is_racker">Actions</th>-->
                            </tr>
                        </thead>
                        <tbody ng-show="!vm.loading && !vm.completedBatches.loadError && vm.completedBatches.items.length!==0">
                            <tr ng-repeat="batch in vm.completedBatches.items | orderBy: vm.sortBy.completed_batch | limitTo : vm.completedBatches.pageSize : (vm.completedBatches.currentPage-1)*vm.completedBatches.pageSize" class="ng-scope">
                                <td class="rs-table-status rs-table-status-ok tip"></td>
                                <td class="rs-table-link large-col"><a ng-link="['CompletedBatchDetails', {job_id: batch.job_id}]" class="ng-binding">{{batch.batch_name}}</a></td>
                                <td class="rs-table-text ng-binding">{{(batch.start && batch.start * 1000) | date : 'M/dd/yyyy hh:mm a'}}</td>
                                <td class="rs-table-text ng-binding" colspan="2">{{(batch.end && batch.end * 1000) | date : 'M/dd/yyyy hh:mm a'}}</td>
                                <!--<td ng-show="vm.is_racker"><a href="" class="rs-btn rs-btn-primary">See Log</a></td>-->
                            </tr>
                        </tbody>
                        <tbody ng-show="vm.loading">
                            <tr>
                                <td colspan="5">
                                    <div class="rs-table-overlay rs-table-overlay-loading">
                                        <div class="rs-table-overlay-content">
                                            <div class="rs-table-overlay-message">Loading&hellip;</div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        <tbody ng-show="!vm.loading && !vm.completedBatches.loadError && vm.completedBatches.items.length===0">
                            <tr>
                                <td colspan="5" class="empty-collection-info">You don't have any completed migrations.</td>
                            </tr>
                        </tbody>
                        <tbody ng-show="!vm.loading && vm.completedBatches.loadError">
                            <tr>
                                <td colspan="5" class="collection-error-msg">Error loading data</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <br>
                <div class="pagination pagination-mini" ng-show="!vm.loading && vm.completedBatches.items.length!==0">
                    <ul>
                        <li><span>Showing {{(vm.completedBatches.currentPage == 1 ? vm.completedBatches.currentPage : ((vm.completedBatches.currentPage-1)*5)+1)}}-{{(vm.completedBatches.currentPage == vm.completedBatches.noOfPages ? vm.completedBatches.items.length : vm.completedBatches.currentPage*5)}} of {{vm.completedBatches.items.length}}</span></li>
                        <li ng-class="{disabled: vm.completedBatches.currentPage == 1}" ng-click="vm.completedBatches.currentPage=vm.completedBatches.currentPage-1"><a href="">Prev</a></li>
                        <li ng-repeat="n in vm.completedBatches.pages track by $index" ng-click="vm.completedBatches.currentPage = $index+1"><a href="">{{$index+1}}</a></li>
                        <li ng-class="{disabled: vm.completedBatches.currentPage == vm.completedBatches.noOfPages}" ng-click="vm.completedBatches.currentPage=vm.completedBatches.currentPage+1"><a href="">Next</a></li>
                    </ul>
                </div>  
                <div class="rs-row">
                    <div class="span-6">
                        <div class="rs-facet-section">
                            <div class="rs-facet-section-body">
                                <h3>Errors/Warnings <span class="rs-quiet">({{vm.alerts.length}})</span></h3>
                                <div class="rs-embedded-list-table-wrapper rs-embedded-medium migration-status-list-container" style="margin-top: 0;">
                                    <table class="rs-list-table rs-embedded-list-table">
                                        <thead>
                                            <tr>
                                                <th>Batch Name</th>
                                                <th>Date</th>
                                                <th>Message</th>
                                            </tr>
                                        </thead>
                                        <tbody ng-show="!vm.loadingAlerts && vm.alerts.length>0">
                                            <tr ng-repeat="alert in vm.alerts | orderBy: 'timestamp'">
                                                <td><span class="rs-status" ng-class="{'rs-status-warning': alert.type==='warning', 'rs-status-error': alert.type==='error'}">{{alert.type}}</span></td>
                                                <td class="rs-table-text ng-binding">{{alert.timestamp | date : 'M/dd/yyyy'}}</td>
                                                <!--<td><a ng-link="['BatchTaskList', {job_id: alert.job_id}]">{{alert.message}}</a></td>-->
                                                <td>{{alert.message}}</td>
                                            </tr>
                                        </tbody>
                                        <tbody ng-show="!vm.loadingAlerts && vm.alerts.length===0">
                                            <tr>
                                                <td colspan="3" class="empty-collection-info">Hooray! You don't have any errors or warnings.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="span-6">
                        <div class="rs-facet-section">
                            <div class="rs-facet-section-body">
                                <a href="https://mycloud.rackspace.com/cloud/{{vm.tenant_id}}/tickets" class="rs-btn rs-btn-link rs-pull-right" target="_blank" role="button" data-trigger="hover" data-placement="top" data-toggle="popover" data-content="Got to tickets in Rackspace Reach">See All <i class="fa fa-angle-double-right"></i></a>
                                <h3>Tickets <span class="rs-quiet">({{vm.tickets.items.length}})</span></h3>
                                <div class="">
                                    <table class="rs-list-table rs-embedded-list-table-wrapper">
                                        <thead>
                                            <tr>
                                                <th>Ticket Number</th>
                                                <th>Date/Time</th>
                                                <th>Message</th>
                                            </tr>
                                        </thead>
                                        <tbody ng-show="!vm.loadingTickets && vm.tickets.items.length>0">
                                            <tr ng-repeat="ticket in vm.tickets.items | orderBy: '-created' | limitTo : vm.tickets.pageSize : (vm.tickets.currentPage-1)*vm.tickets.pageSize">
                                                <td><a href="https://mycloud.rackspace.com/cloud/{{vm.tenant_id}}/tickets#{{ticket.ticket_id}}">{{ticket.ticket_id}}</a></td>
                                                <td class="rs-table-text ng-binding">{{ticket.created | date : 'M/dd/yyyy hh:mm a'}}</td>
                                                <td>
                                                    {{ticket.description | limitTo: 30}}
                                                    <span ng-show="ticket.description.length > 30">...</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tbody ng-show="!vm.loadingTickets && vm.tickets.length===0">
                                            <tr>
                                                <td colspan="3" class="empty-collection-info">You don't have any tickets.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <br>
                                <div class="pagination pagination-mini" ng-show="!vm.loadingTickets && vm.tickets.items.length!==0">
                                    <ul>
                                        <li><span>Showing {{(vm.tickets.currentPage == 1 ? vm.tickets.currentPage : ((vm.tickets.currentPage-1)*vm.tickets.pageSize)+1)}}-{{(vm.tickets.currentPage == vm.tickets.noOfPages ? vm.tickets.items.length : vm.tickets.currentPage*vm.tickets.pageSize)}} of {{vm.tickets.items.length}}</span></li>
                                        <li ng-class="{disabled: vm.tickets.currentPage == 1}" ng-click="vm.tickets.currentPage=vm.tickets.currentPage-1"><a href="">Prev</a></li>
                                        <li ng-repeat="n in vm.tickets.pages track by $index" ng-click="vm.tickets.currentPage = $index+1"><a href="">{{$index+1}}</a></li>
                                        <li ng-class="{disabled: vm.tickets.currentPage == vm.tickets.noOfPages}" ng-click="vm.tickets.currentPage=vm.tickets.currentPage+1"><a href="">Next</a></li>
                                    </ul>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="abort_continue" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="ModalForNoSelect" aria-hidden="true">
    <div class="modal-body" style="height: 150px">
        <h3 style="margin-top: 40px; text-align: center">Migration for one or more resources in this batch has already been scheduled in another batch. Cannot continue.</h3>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
    </div>
</div>

<div id="browser_back" class="modal modal-warning hide animated fadeIn" tabindex="-1" role="dialog" aria-labelledby="ModalForNoSelect" aria-hidden="true">
     <div class="modal-header">
         <h3><i class="fa fa-warning"></i> Invalid Action! </h3>
     </div>
     <div class="modal-body">
        <p><big>You just scheduled a migration. Please click '<b>Proceed </b>' to start a new migration again</big></p>
      </div>
      <div class="modal-footer">
          <button ng-click="vm.startNewMigration()" type="button" class="rs-btn" data-dismiss="modal">Proceed</button>
          <button type="button" class="rs-btn" data-dismiss="modal">Cancel</button>
      </div>
</div>

<script type="text/javascript">
    $(document).ready(function() {
        var index,elements = $('li[class*=" racker-nav-item active"]');
        if(elements.length != 0){
            for(index =0;index<elements.length;index++){
                var id = elements[index].id;
                document.getElementById(id).className -= " racker-nav-item active";
            }
        }
        if(document.getElementById("racker-migration-mgr")){
            document.getElementById("racker-migration-mgr").style.visibility = "visible";
            document.getElementById("racker-migration-mgr").className += " racker-nav-item active";
        }
    });
</script>
