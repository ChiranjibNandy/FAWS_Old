{% extends "_template_full.html" %}

{% block title %}FAWS Migrations{% endblock %}

{% block main %}

  {# THIS IS JUST AN EXAMPLE OF A SUPER SIMPLE, SINGLE PAGE ANGULAR COMPONENT #}

  <script>
    (function () {
        "use strict";

        // defining component to display details of the items to be migrated
        angular.module("migrationApp")
            .component("rsmigrations", {
                templateUrl: "migration_template.html",
                controllerAs: "vm",
                controller: ["migrationitemdataservice",'$filter', function (ds, $filter) {
                    var vm = this;

                    // When the component is active get router params and fetch data
                    vm.$onInit = function() {
                        vm.migrations = [];
                        vm.loaded = false;
                        vm.servers = []

                        ds.getAllUSServers()
                            .then(function (response) {
                                vm.servers = response;
                                vm.loaded = true;
                            });
                        // fetch details based on selected migration item
                        ds.getAllMigrations(1024814)
                            .then(function (response) {
                                vm.tenant_id = response.id;
                                response.jobs.forEach(function(migration){
                                    ds.getMigration(migration.id)
                                        .then(function (response){
                                            while(vm.loaded === false) {
                                                setTimeout(function(){
                                                    console.log("sleeping for 1 second while waiting for servers")
                                                }, 500);
                                            }
                                            var instance_uuid;
                                            for(instance_uuid in response.results.instances){
                                                var region;
                                                var server_name = instance_uuid;
                                                for(region in vm.servers){
                                                    var server_by_id = $filter('filter')(vm.servers[region].servers, {id: instance_uuid });
                                                    if (server_by_id.length == 1) {
                                                        server_name = server_by_id[0].name;
                                                        break;
                                                    }
                                                }

                                                var progress = 0;
                                                var status = response.results.instances[instance_uuid].status;

                                                if (status === 'in progress') {
                                                    progress = 50;
                                                }
                                                else if (status === 'done') {
                                                    progress = 100;
                                                }

                                                var item = {
                                                    id: response.id,
                                                    name: server_name,
                                                    status: response.results.instances[instance_uuid].status,
                                                    progress: progress
                                                };

                                                vm.migrations.push(item);
                                            }
                                    });
                            });
                        });
                    }; // end of $routerOnActivate
                    return vm;
                }] // end of component controller
            }); // end of component definition
    })();
  </script>
  <div ng-app="migrationApp" class="rs-container">
    <div class="rs-content rs-panel">
        <div class="rs-inner rs-mig-nomar">
            <script type="text/ng-template" id="migration_template.html">
                <!-- <div class="rs-content rs-panel"> -->
                <div class="migration-details-container">
                    <div class="rs-row">
                        <div class="migration-item-header">
                            <h2 class="rs-page-title migration-item-type span-9">Migrations ({{ vm.tenant_id }})</h2>
                        </div>

                        <div class="span-12">
                            <div class="rs-embedded-list-table-wrapper rs-embedded-medium">
                                <table class="rs-list-table rs-embedded-list-table">
                                    <thead>
                                        <tr>
                                            <th>
                                                <span class="rs-table-sort-text">Job Id</span>
                                            </th>
                                            <th>
                                                <span class="rs-table-sort-text">Server</span>
                                            </th>
                                            <th>
                                                <span class="rs-table-sort-text">Status</span>
                                            </th>
                                            <th>
                                                <span class="rs-table-sort-text">Progress</span>
                                            </th>
                                            <th>
                                                <span class="rs-table-sort-text">View Details</span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="item in vm.migrations">
                                            <td class="rs-table-text">{{item.id}}</td>
                                            <td class="rs-table-text">{{item.name}}</td>
                                            <td class="rs-table-text">{{item.status}}</td>
                                            <td class="rs-table-text">
                                                <div class="rs-progress">
                                                    <div class="rs-progress-inner">
                                                        <div class="rs-segment" style="width: {{item.progress}}%">
                                                            <div class="rs-bar rs-status-ok"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="rs-table-link"><a href="#" ng-link="['MigrationLogDetails', {type: vm.type, id: item.id}]">View Details</a></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- </div> -->
            </script>
            <rsmigrations></rsmigrations>
        </div>
    </div>
  </div>

{% endblock %}
